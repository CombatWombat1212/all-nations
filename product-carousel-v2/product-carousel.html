<div class="product-carousel--graphic">
  <div class="product-carousel--background-wrapper">
    <img
      height="1828"
      width="2020"
      class="product-carousel--background-img"
      src="https://allnationscanna.ca/wp-content/uploads/2023-refresh/products-background-01.png"
      alt=""
      srcset="
        https://allnationscanna.ca/wp-content/uploads/2023-refresh/products-background-01_320.webp   320w,
        https://allnationscanna.ca/wp-content/uploads/2023-refresh/products-background-01_640.webp   640w,
        https://allnationscanna.ca/wp-content/uploads/2023-refresh/products-background-01_960.webp   960w,
        https://allnationscanna.ca/wp-content/uploads/2023-refresh/products-background-01_1280.webp 1280w,
        https://allnationscanna.ca/wp-content/uploads/2023-refresh/products-background-01_1600.webp 1600w,
        https://allnationscanna.ca/wp-content/uploads/2023-refresh/products-background-01_1920.webp 1920w,
        https://allnationscanna.ca/wp-content/uploads/2023-refresh/products-background-01_2020.webp 2020w
      "
      sizes="(max-width: 2020px) 100vw, 2020px" />
  </div>

  <div class="product-carousel--graphic-list">
    <div class="product-carousel--graphic-wrapper active" data-img="0">
      <img
        class="product-carousel--grapic-img"
        height="1381"
        width="1920"
        src="https://allnationscanna.ca/wp-content/uploads/2023-refresh/Tropic-Thunder.png"
        alt=""
        srcset="
          https://allnationscanna.ca/wp-content/uploads/2023-refresh/Tropic-Thunder_320.webp   320w,
          https://allnationscanna.ca/wp-content/uploads/2023-refresh/Tropic-Thunder_640.webp   640w,
          https://allnationscanna.ca/wp-content/uploads/2023-refresh/Tropic-Thunder_960.webp   960w,
          https://allnationscanna.ca/wp-content/uploads/2023-refresh/Tropic-Thunder_1280.webp 1280w,
          https://allnationscanna.ca/wp-content/uploads/2023-refresh/Tropic-Thunder_1600.webp 1600w,
          https://allnationscanna.ca/wp-content/uploads/2023-refresh/Tropic-Thunder_1920.webp 1920w
        "
        sizes="(max-width: 1920px) 100vw, 1920px" />
    </div>
    <div class="product-carousel--graphic-wrapper hidden" data-img="1">
      <img
        class="product-carousel--grapic-img"
        height="1381"
        width="1920"
        src="https://allnationscanna.ca/wp-content/uploads/2023-refresh/Cherry-Gas.png"
        alt=""
        srcset="
          https://allnationscanna.ca/wp-content/uploads/2023-refresh/Cherry-Gas_320.webp   320w,
          https://allnationscanna.ca/wp-content/uploads/2023-refresh/Cherry-Gas_640.webp   640w,
          https://allnationscanna.ca/wp-content/uploads/2023-refresh/Cherry-Gas_960.webp   960w,
          https://allnationscanna.ca/wp-content/uploads/2023-refresh/Cherry-Gas_1280.webp 1280w,
          https://allnationscanna.ca/wp-content/uploads/2023-refresh/Cherry-Gas_1600.webp 1600w,
          https://allnationscanna.ca/wp-content/uploads/2023-refresh/Cherry-Gas_1920.webp 1920w
        "
        sizes="(max-width: 1920px) 100vw, 1920px" />
    </div>
    <div class="product-carousel--graphic-wrapper hidden" data-img="2">
      <img
        class="product-carousel--grapic-img"
        height="1381"
        width="1920"
        src="https://allnationscanna.ca/wp-content/uploads/2023-refresh/Stolo-Haze.png"
        alt=""
        srcset="
          https://allnationscanna.ca/wp-content/uploads/2023-refresh/Stolo-Haze_320.webp   320w,
          https://allnationscanna.ca/wp-content/uploads/2023-refresh/Stolo-Haze_640.webp   640w,
          https://allnationscanna.ca/wp-content/uploads/2023-refresh/Stolo-Haze_960.webp   960w,
          https://allnationscanna.ca/wp-content/uploads/2023-refresh/Stolo-Haze_1280.webp 1280w,
          https://allnationscanna.ca/wp-content/uploads/2023-refresh/Stolo-Haze_1600.webp 1600w,
          https://allnationscanna.ca/wp-content/uploads/2023-refresh/Stolo-Haze_1920.webp 1920w
        "
        sizes="(max-width: 1920px) 100vw, 1920px" />
    </div>
    <div class="product-carousel--graphic-wrapper hidden" data-img="3">
      <img
        class="product-carousel--grapic-img"
        height="1381"
        width="1920"
        src="https://allnationscanna.ca/wp-content/uploads/2023-refresh/Modified-Grapes.png"
        alt=""
        srcset="
          https://allnationscanna.ca/wp-content/uploads/2023-refresh/Modified-Grapes_320.webp   320w,
          https://allnationscanna.ca/wp-content/uploads/2023-refresh/Modified-Grapes_640.webp   640w,
          https://allnationscanna.ca/wp-content/uploads/2023-refresh/Modified-Grapes_960.webp   960w,
          https://allnationscanna.ca/wp-content/uploads/2023-refresh/Modified-Grapes_1280.webp 1280w,
          https://allnationscanna.ca/wp-content/uploads/2023-refresh/Modified-Grapes_1600.webp 1600w,
          https://allnationscanna.ca/wp-content/uploads/2023-refresh/Modified-Grapes_1920.webp 1920w
        "
        sizes="(max-width: 1920px) 100vw, 1920px" />
    </div>
    <div class="product-carousel--graphic-wrapper hidden" data-img="4">
      <img
        class="product-carousel--grapic-img"
        height="1381"
        width="1920"
        src="https://allnationscanna.ca/wp-content/uploads/2023-refresh/Mac-Daddy.png"
        alt=""
        srcset="
          https://allnationscanna.ca/wp-content/uploads/2023-refresh/Mac-Daddy_320.webp   320w,
          https://allnationscanna.ca/wp-content/uploads/2023-refresh/Mac-Daddy_640.webp   640w,
          https://allnationscanna.ca/wp-content/uploads/2023-refresh/Mac-Daddy_960.webp   960w,
          https://allnationscanna.ca/wp-content/uploads/2023-refresh/Mac-Daddy_1280.webp 1280w,
          https://allnationscanna.ca/wp-content/uploads/2023-refresh/Mac-Daddy_1600.webp 1600w,
          https://allnationscanna.ca/wp-content/uploads/2023-refresh/Mac-Daddy_1920.webp 1920w
        "
        sizes="(max-width: 1920px) 100vw, 1920px" />
    </div>
    <div class="product-carousel--graphic-wrapper hidden" data-img="5">
      <img
        class="product-carousel--grapic-img"
        height="1381"
        width="1920"
        src="https://allnationscanna.ca/wp-content/uploads/2023-refresh/Lemon-Tartz.png"
        alt=""
        srcset="
          https://allnationscanna.ca/wp-content/uploads/2023-refresh/Lemon-Tartz_320.webp   320w,
          https://allnationscanna.ca/wp-content/uploads/2023-refresh/Lemon-Tartz_640.webp   640w,
          https://allnationscanna.ca/wp-content/uploads/2023-refresh/Lemon-Tartz_960.webp   960w,
          https://allnationscanna.ca/wp-content/uploads/2023-refresh/Lemon-Tartz_1280.webp 1280w,
          https://allnationscanna.ca/wp-content/uploads/2023-refresh/Lemon-Tartz_1600.webp 1600w,
          https://allnationscanna.ca/wp-content/uploads/2023-refresh/Lemon-Tartz_1920.webp 1920w
        "
        sizes="(max-width: 1920px) 100vw, 1920px" />
    </div>
  </div>
</div>

<script>
  async function carouselInit() {
    try {
      // console.log('Attempting to get the carousel object');
      const carousel = await carouselGet();
      if (carousel) {
        // console.log('Carousel object obtained:', carousel);
        carouselStartObserver(carousel);
        carouselUpdate(carousel);
      } else {
        // console.log('Carousel object is null');
      }
    } catch (error) {
      // console.error("Failed to initialize carousel:", error);
    }
  }

  function waitForElement(selector, retryInterval = 100, maxRetries = 50000) {
    // console.log(`Waiting for element: ${selector}`);
    return new Promise((resolve, reject) => {
      let retries = 0;

      function search() {
        const element = document.querySelector(selector);
        if (element) {
          // console.log(`Element ${selector} found`);
          resolve(element);
        } else {
          retries++;
          if (retries <= maxRetries) {
            setTimeout(search, retryInterval);
          } else {
            // console.error(`Element ${selector} not found after ${maxRetries} retries`);
            reject(new Error(`Element ${selector} not found after ${maxRetries} retries`));
          }
        }
      }

      search();
    });
  }

  async function carouselGet() {
    try {
      // console.log('Getting carousel elements');
      const carouselElement = await waitForElement(".product-carousel");
      const paginationElement = await waitForElement(".product-carousel .flickity-page-dots");

      carouselElement.setAttribute("data-page", 0);

      const carousel = {
        element: carouselElement,
        pagination: {
          element: paginationElement,
          dots: await Promise.all(
            Array.from(paginationElement.children).map(async (child) => ({
              element: child,
              active: false,
            }))
          ),
        },
        images: Array.from(carouselElement.querySelectorAll(".product-carousel--graphic-wrapper")),
        currentPage: 0,
      };

      // console.log('Carousel elements obtained:', carousel);
      return carousel;
    } catch (error) {
      // console.error('Error getting carousel elements:', error);
      return null;
    }
  }

  function carouselStartObserver(carousel) {
    // console.log('Starting mutation observer for carousel');
    const updateDotActiveStatus = (dotElement) => {
      const dotObject = carousel.pagination.dots.find((dot) => dot.element === dotElement);
      if (!dotObject) return;
      const isActive = dotElement.classList.contains("is-selected");
      if (dotObject.active !== isActive) {
        dotObject.active = isActive;
        // console.log(`Dot status changed. Dot index: ${carousel.pagination.dots.indexOf(dotObject)}, Active: ${isActive}`);
        carouselPageChange(carousel);
      }
    };

    const observerCallback = (mutationsList) => {
      for (let mutation of mutationsList) {
        if (mutation.type === "attributes" && mutation.attributeName === "class") {
          // console.log('Mutation observed:', mutation);
          updateDotActiveStatus(mutation.target);
        }
      }
    };

    const observerConfig = {
      attributes: true,
      attributeFilter: ["class"],
    };

    const observer = new MutationObserver(observerCallback);
    carousel.pagination.dots.forEach((dot) => observer.observe(dot.element, observerConfig));
    // console.log('Mutation observer started for each dot');
  }

  function carouselPageChange(carousel) {
    // console.log('Checking for carousel page change');
    const activeDotIndex = carousel.pagination.dots.findIndex((dot) => dot.active);
    if (activeDotIndex === -1) {
      // console.log('No active dot found');
      return;
    }

    if (carousel.currentPage !== activeDotIndex) {
      // console.log(`Page change detected: from ${carousel.currentPage} to ${activeDotIndex}`);
      carousel.element.setAttribute("data-page", activeDotIndex);
      carousel.currentPage = activeDotIndex;
      carouselUpdate(carousel);
    }
  }

  function carouselUpdate(carousel) {
    // console.log(`Updating carousel for page ${carousel.currentPage}`);
    const elems = Array.from(document.querySelectorAll(".product-carousel--graphic-wrapper"));
    elems.forEach((elem, index) => {
      if (index === carousel.currentPage) {
        // console.log(`Setting element at index ${index} as active`);
        elem.classList.add("active");
        elem.classList.remove("hidden");
      } else {
        // console.log(`Setting element at index ${index} as hidden`);
        elem.classList.remove("active");
        elem.classList.add("hidden");
      }
    });
  }

  carouselInit();

  const regions = ["canada", "israel", "europe", "australia"];

  const strains = processStrainsObj({
    stolo_haze: {},

    tropic_thunder: {
      hide: {
        israel: true,
        europe: true,
        australia: true,
      },
    },

    cherry_gas: {
      title: {
        israel: "Mac Doughnut",
        europe: "Mac Doughnut",
      },
      description: {
        israel:
          "Mac Doughnut is cross of Mac 1 and Powdered Donuts. This Indica leaning strain offers a unique aroma of ripe citrus fruit and diesel. Mac Doughnut has dense trichome covered buds, with a deep green hue accentuated with subtle touches of purple.",
        europe:
          "Mac Doughnut is cross of Mac 1 and Powdered Donuts. This Indica leaning strain offers a unique aroma of ripe citrus fruit and diesel. Mac Doughnut has dense trichome covered buds, with a deep green hue accentuated with subtle touches of purple.",
      },
      aromas: {
        israel: "Sweet, Citrus, Diesel",
        europe: "Sweet, Citrus, Diesel",
      },
      lineage: {
        israel: "Mac 1 x Powdered Donuts",
        europe: "Mac 1 x Powdered Donuts",
      },
    },

    modified_grapes: {
      hide: {
        israel: true,
        europe: true,
        australia: true,
      },
    },

    mac_daddy: {
      hide: {
        europe: true,
      },
    },

    lemon_tartz: {
      title: {
        europe: "Pineapple Express",
      },
      description: {
        europe:
          "Pineapple Express is a cross between Trainwreck and Hawaiian. This aromatic Sativa strain has a distinct citrus and pineapple nose. The light green buds are dense and covered by a frosty coating of trichomes.",
      },
      Aromas: {
        europe: "Citrus, Pineapple, Pine.",
      },
      lineage: {
        europe: "Trainwreck x Hawaiian",
      },
    },

    peanut_butter_breath: {},

    gush_mintz: {},
  });

  const varyingProperties = ["title", "description", "aromas", "lineage"];

  function mergeStrains(foundStrains, strainsObj) {
    Object.keys(foundStrains).forEach((foundKey) => {
      const foundStrainName = foundStrains[foundKey].title;

      if (!strainsObj[foundStrainName]) return;
      if (!foundStrains[foundKey]?.elements?.title) return;

      const title = foundStrains[foundKey].elements.title;
      const parent = title.parentElement;
      const description = parent.querySelector(".product-carousel--description");
      const aromas = parent.querySelector(".product-carousel--profile-description");
      const lineage = parent.querySelector(".product-carousel--lineage");

      strainsObj[foundStrainName].elements = {
        title,
        description,
        aromas,
        lineage,
      };

      function updateProperty(propertyName, value) {
        if (!strainsObj[foundStrainName][propertyName]) {
          strainsObj[foundStrainName][propertyName] = { default: value.innerHTML };
        } else {
          strainsObj[foundStrainName][propertyName].default = value.innerHTML;
        }
      }

      updateProperty("title", title);
      updateProperty("description", description);
      updateProperty("aromas", aromas);
      updateProperty("lineage", lineage);
    });

    // console.log(strainsObj);
    return strainsObj;
  }

  function processStrainsObj(STRAIN_DATA) {
    const regions = ["canada", "israel", "europe", "australia"];

    Object.keys(STRAIN_DATA).forEach((strainKey) => {
      const strain = STRAIN_DATA[strainKey];

      if (!strain.hide) {
        strain.hide = {};
      }

      regions.forEach((region) => {
        if (strain.hide[region] === undefined) {
          strain.hide[region] = false;
        }
      });
    });

    return STRAIN_DATA;
  }

  async function findStrainTitles() {
    const firstTitle = await waitForElement(`.product-carousel--strain`);
    const titles = Array.from(document.querySelectorAll(`.product-carousel--strain`));
    const foundStrains = {};

    titles.forEach((element, index) => {
      let title = element.innerHTML.toLowerCase();
      title = title.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
      title = title.replace(/[^a-z0-9 ]/g, "");
      title = title.replace(/ /g, "_");

      foundStrains[`strain_${index}`] = {
        elements: {
          title: element,
        },
        title: title,
      };
    });

    const mergedStrains = mergeStrains(foundStrains, strains);

    getCountryRegionKey().then((regionKey) => {
      if (!regionKey) return;

      Object.keys(mergedStrains).forEach((key) => {
        const strain = mergedStrains[key];
        // if (!strain.variants) return;
        if (!strain.elements) return;

        function updateStrainProperty() {
          varyingProperties.forEach((property) => {
            if (!strain[property]) return;
            if (!strain.elements[property]) return;
            if (!strain[property].default) return;
            if (!strain[property][regionKey]) return;

            strain.elements[property].innerHTML = strain[property][regionKey];
          });
        }

        updateStrainProperty();

        // if (!strain.elements.title) return;
        // strain.elements.title.innerHTML = strain.name[regionKey] || strain.name.default;
      });
    });
  }

  findStrainTitles();

  async function getCountryRegionKey() {
    try {
      const response = await fetch("https://ipapi.co/json/");
      const data = await response.json();
      const countryCode = data.country;

      if (data.country_name === "Australia") {
        return "australia";
      } else if (data.country_name === "Canada") {
        return "canada";
      } else if (data.country_name === "Israel") {
        return "israel"; // Corrected typo
      } else if (
        [
          "AT",
          "BE",
          "BG",
          "CY",
          "CZ",
          "DE",
          "DK",
          "EE",
          "ES",
          "FI",
          "FR",
          "GR",
          "HR",
          "HU",
          "IE",
          "IT",
          "LT",
          "LU",
          "LV",
          "MT",
          "NL",
          "PL",
          "PT",
          "RO",
          "SE",
          "SI",
          "SK",
        ].includes(countryCode)
      ) {
        return "europe";
      } else {
        return ""; // Default case if country does not match any specified regions
      }
    } catch (error) {
      console.error("Error fetching user location:", error);
      return ""; // Return an empty string or a default value in case of an error
    }
  }
</script>
